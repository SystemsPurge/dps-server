# DPS-SERVER
### HTTP api for dpsim basic usage and pandapower optimal powerflow

# ENV
- `DPS_LOG_LEVEL` : all the log levels supported by the python logging module
# Usage
## Docker
Run docker image `registry.git.rwth-aachen.de/acs/public/dpsv:latest`:
`docker run -p 5000:5000 registry.git.rwth-aachen.de/acs/public/dpsv:latest`
Then send your requests to localhost:5000.<br>
Optionally mount a db folder instead of using http, then use the container cli,
container mount path has to correspond to the DPS_ROOT variable.<br>
`docker run --name dpsv -v $(pwd)/db:/dpsroot registry.git.rwth-aachen.de/acs/public/dpsv:latest`.<br>
You can then put your needed files (xml,profiles) directly in the corresponding db subfolder,and use the cli:
`docker exec dpsv sh -c 'dps run -ux <xml> -up <profile>...etc'`
In this manner, results are retrieved from `<db folder>/result/<sim name>`.<br>

## Helm
To install chart locally on a kubernetes cluster, run 
`helm install dpsv ./helm-dpsv --namespace dpsv --create-namespace`
From the root folder. Change persist to true in values, to persist the timeseries/results database 
Server has no authentication, hiding it behind a proxy+ IDP is a good idea.<br>

## Open API spec
Generated by fastapi at `/docs` endpoint, see [here](https://fastapi.tiangolo.com/#interactive-api-docs) to learn more.<br>

## DPSIM Usage
DPSIM repo is found [here](https://github.com/sogno-platform/dpsim).
This server mirrors some functionality of dpsim, more can be found in the [docs](https://dpsim.fein-aachen.org/docs/).<br>

## Pandapower Usage
This server provides [the optimal powerflow implemented by pandapower](https://github.com/e2nIEE/pandapower/blob/develop/tutorials/pandamodels_opf.ipynb).<br>

This functionality is "TODO" and not fully implemented yet.<br>
## üöÄ API Reference

This document provides a reference for the available endpoints and data models in the system.

---

### ‚è≥ Time Series Profile (JSON)

These endpoints handle uploading and retrieving time series data in a **JSON** format.

| Method | Path | Summary | Description |
| :--- | :--- | :--- | :--- |
| **`POST`** | `/jts/profile/{tsname}` | **Post Jts** | Upload a profile time series JSON. |
| **`GET`** | `/jts/result/{tsname}` | **Get Jts** | Get a result time series as JSON. |

#### **`POST` /jts/profile/{tsname}**
* **Description:** Upload a profile time series JSON.
* **Path Parameter:**
    * `tsname` (`string`, **required**): The name of the time series being uploaded.
* **Request Body:** An array of `TableRow` objects (JSON).
* **Successful Response (200):** `UploadFileResult` (e.g., `{"filename": "sim-run-1"}`)

#### **`GET` /jts/result/{tsname}**
* **Description:** Get a result time series as JSON.
* **Path Parameter:**
    * `tsname` (`string`, **required**): Name of time series to fetch.
* **Successful Response (200):** `JsonTimeseriesResult`

---

### ‚öôÔ∏è Simulation Endpoint

This endpoint initiates a simulation run.

| Method | Path | Summary | Description |
| :--- | :--- | :--- | :--- |
| **`POST`** | `/s` | **Run Sim** | Run a simulation. |

#### **`POST` /s**
* **Description:** Run a simulation.
* **Request Body:** `SimParameters` object (JSON) containing configuration for the simulation.
* **Successful Response (200):** `UploadFileResult` (e.g., `{"filename": "sim-run-1"}`)

---

### üóÑÔ∏è XML (CIM Archive) Endpoints

These endpoints manage the uploading, listing, and deletion of **CIM data archives** (XML/ZIP).

| Method | Path | Summary | Description |
| :--- | :--- | :--- | :--- |
| **`GET`** | `/xml` | **List Xml** | List all CIM archive names. |
| **`POST`** | `/xml` | **Post Xml** | Post CIM data archive (multipart/form-data). |
| **`DELETE`** | `/xml/{xmlname}` | **Delete Xml** | Delete a system's CIM archive. |

#### **`POST` /xml**
* **Description:** Post CIM data archive.
* **Request Body:** `multipart/form-data` with a `file` field (zip archive containing CIM xml profiles).
* **Successful Response (200):** `UploadFileResult`

#### **`GET` /xml**
* **Description:** List all CIM archive names.
* **Successful Response (200):** `ListResult`

#### **`DELETE` /xml/{xmlname}**
* **Description:** Delete a system's CIM archive.
* **Path Parameter:**
    * `xmlname` (`string`, **required**): Name of the archive to delete.
* **Successful Response (200):** `UploadFileResult`

---

### üìä Time Series File Endpoints (Legacy/Deprecated)

These endpoints handle time series data as files.

| Method | Path | Summary | Description |
| :--- | :--- | :--- | :--- |
| **`POST`** | `/ts/profile` | **Post Ts** | Upload a profile time series file (multipart/form-data). **(Deprecated)** |
| **`GET`** | `/ts/{tstype}` | **List Ts** | List time series data of a certain resource. |
| **`DELETE`** | `/ts/{tstype}/{tsname}` | **Delete Ts** | Delete a time series from the file database. **(Deprecated)** |

#### **`GET` /ts/{tstype}**
* **Description:** List time series data of a certain resource.
* **Path Parameter:**
    * `tstype` (`string`, **required**): The type of the time series being fetched, one of **`profile`** or **`result`**.
* **Successful Response (200):** `ListResult`

---

### üìë Schema Definitions (Models)

The following models define the structure of data used in the requests and responses.

#### `SimParameters`
Parameters required to run a simulation.

| Property | Type | Description | Default | Example |
| :--- | :--- | :--- | :--- | :--- |
| **`name`** | `string` | Name of the simulation/produced result file. | `a9dd9b425335` | `sim-run-1` |
| **`freq`** | `integer` | Frequency of power grid. | `50` | `50` |
| **`duration`** | `integer` | Duration of simulation in timesteps. | `300` | `300` |
| **`timestep`** | `number` | Timestep of simulation. | `1` | `1` |
| **`opf`** | `boolean` | Generate a profile from a pandapower optimal powerflow. | `false` | `false` |
| **`use_profile`** | `string` or `null` | Use uploaded profile data, by keyword. | `null` | |
| **`replace_map`** | `object` or `null` | Replace component name parts to reconcile profiles and simulation. | `null` | `{"sym": "machine"}` |
| **`use_xml`** | `string` | CIM data to describe simulated system, by keyword. | | `cim-data-1` |
| **`domain`** | `string` | Domain of simulation (**SP** for Steady-state Power, etc.). | `SP` | `SP` |
| **`solver`** | `string` | Simulation solver type. | `NRP` | `NRP` |

#### `TableRow`
Represents a single measurement or data point in a time series profile.

| Property | Type | Description | Required | Example |
| :--- | :--- | :--- | :--- | :--- |
| **`ts`** | `integer` | **Timestamp** of given measurement in **unix timestamp** format. | Yes | `1764627480` |
| **`value`** | `number` | Measured value. | Yes | `0.1` |
| **`profile_type`** | `string` | What the measured value represents (e.g., active power). | Yes | `SOME_LINE_COMPONENT` |
| **`power_type`** | `string` | Active or reactive, not strict, can contain 'active' or 'reactive' as substring. | Yes | `active` |
| `[extra_fields]` | Any | All extra fields are used as a label (e.g., `bus`, `line`). | No | `{"bus": "SOME_BUS_NAME"}` |

#### `JsonTimeseries`
A full time series structure, used for results.

| Property | Type | Description | Required | Example |
| :--- | :--- | :--- | :--- | :--- |
| **`time`** | `array` of `integer` | **Required.** A list of time values, one of integer timesteps or unix timestamps. | Yes | `[0.0, 0.5, 1.0, 1.5, 2.0]` |
| `[series_name]` | `array` of `number` | Keys map to time series names (e.g., sensor\_x), values are the measurement list. | No | `{"sensor_x": [10.1, 10.2, 10.3, 10.4, 10.5]}` |

#### `UploadFileResult`
Standard response model after a successful file upload or deletion.

| Property | Type | Description | Example |
| :--- | :--- | :--- | :--- |
| **`filename`** | `string` | Named resource result: filename, simulation name, profile/result name. | `sim-run-1` |

#### `ListResult`
Standard response model for listing resource names.

| Property | Type | Description | Example |
| :--- | :--- | :--- | :--- |
| **`lst`** | `array` of `string` | String list result. | `["cim-data-1", "cim-data-2"]` |

#### Other Models

* **`JsonTimeseriesResult`**: Contains the full `JsonTimeseries` object under the key `result`.
* **`HTTPValidationError`**: Standard FastAPI model for validation errors.
* **`ValidationError`**: Details of a validation error.
* **`Body_post_xml_xml_post`**: Multipart model for posting XML files.
* **`Body_post_ts_ts_profile_post`**: Multipart model for posting TS profile files.